#!/bin/bash
echo "ğŸ”¥ INICIANDO RESCATE TOTAL DE TU CÃ“DIGO PERDIDO ğŸ”¥"

# Carpeta donde vamos a vomitar TODO lo recuperado
TARGET="RESCUED_FILES_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$TARGET"
cd "$TARGET" || exit 1

# Lista todos los commits que git aÃºn recuerda (reflog + dangling)
COMMITS=$(git reflog | awk '{print $1}' | sort -u)
COMMITS="$COMMITS $(git fsck --lost-found | awk '/dangling commit/ {print $3}')"

echo "Encontrados $(echo "$COMMITS" | wc -w) commits en el limbo... extrayendo todo..."

for commit in $COMMITS; do
    echo "ğŸ§¹ Revisando commit: $commit"
    
    # Intentamos extraer TODOS los archivos de ese commit
    if git show --pretty="" --name-only "$commit" | grep -q .; then
        git archive --format=tar "$commit" 2>/dev/null | tar x 2>/dev/null
        
        # Si se extrajo algo, renombramos conflictos
        if [ "$(find . -type f | wc -l)" -gt 0 ]; then
            for file in $(find . -type f); do
                if [ -f "../$file" ]; then
                    dir=$(dirname "$file")
                    base=$(basename "$file")
                    name="${base%.*}"
                    ext="${base##*.}"
                    [ "$name" = "$base" ] && ext="" && name="$base"
                    
                    counter=1
                    newfile="$dir/${name}$counter${ext:+.$ext}"
                    while [ -f "../$newfile" ]; do
                        counter=$((counter + 1))
                        newfile="$dir/${name}$counter${ext:+.$ext}"
                    done
                    echo "   âš¡ Conflicto â†’ $file  â†’  $newfile"
                    mkdir -p "$(dirname "../$newfile")"
                    cp "$file" "../$newfile"
                else
                    mkdir -p "$(dirname "../$file")"
                    cp "$file" ../
                fi
            done
            # Limpiamos para el siguiente commit
            find . -mindepth 1 -delete
        fi
    fi
done

cd ..
echo "ğŸ‰ Â¡RESCATE COMPLETADO!"
echo "   Todos tus archivos estÃ¡n en: $TARGET"
echo "   Y tambiÃ©n hay copias con sufijos (nombre1.java, nombre2.java, etc.)"
echo "   BuscÃ¡ tu ProductoEscalar.java, PRG/, Q_1/src/, etc."
echo ""
echo "   Cuando encuentres lo que necesitas, copiÃ¡ a mano lo bueno y borrÃ¡ el resto."
echo "   Nunca mÃ¡s hagas reset --hard sin backup, rey ğŸ˜˜ğŸ’€"

# Bonus: buscamos tu archivo estrella
echo ""
echo "ğŸ” BÃºsqueda rÃ¡pida de ProductoEscalar.java:"
find . -name "ProductoEscalar.java" -type f 2>/dev/null | head -10

echo ""
echo "ğŸ” BÃºsqueda rÃ¡pida de carpetas PRG o Q_1:"
find . -type d -name "PRG" -o -name "Q_1" 2>/dev/null | head -10
